<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Marley Shorts - Pro</title>
    
    <!-- PWA / Mobile Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --yt-red: #ff0000;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000;
            color: white;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* YouTube Shorts Container */
        .shorts-wrapper {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .shorts-wrapper::-webkit-scrollbar { display: none; }

        .short-card {
            height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
            will-change: transform;
        }

        /* Visual Style */
        .video-fx {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, var(--color, #6366f1) 0%, #000 100%);
            opacity: 0.6;
            z-index: 0;
            animation: pulse 6s infinite alternate ease-in-out;
        }
        @keyframes pulse { from { opacity: 0.4; transform: scale(1); } to { opacity: 0.7; transform: scale(1.1); } }

        /* YouTube Sidebar */
        .sidebar {
            position: absolute;
            right: 8px;
            bottom: calc(110px + var(--safe-bottom));
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            z-index: 100;
        }
        .sidebar-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .icon-box { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .label { font-size: 11px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.9); }

        .profile-ring {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid #fff;
            position: relative;
            margin-bottom: 8px;
        }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .plus-sub {
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--yt-red);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 900;
            border: 2px solid #000;
        }

        /* Bottom UI */
        .bottom-ui {
            position: absolute;
            bottom: calc(25px + var(--safe-bottom));
            left: 12px;
            right: 70px;
            z-index: 100;
            pointer-events: none;
        }
        .handle-row {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
        }
        .sub-btn { background: #fff; color: #000; padding: 5px 12px; border-radius: 100px; font-size: 11px; font-weight: 700; }
        .cap-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        /* Canvas Content */
        .main-canvas { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0 30px; }
        .emoji-hero { font-size: 10rem; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8)); font-family: 'Quicksand', sans-serif; margin-bottom: 25px; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 340px; }
        .opt-btn { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(25px); border: 1.5px solid rgba(255, 255, 255, 0.2); border-radius: 14px; padding: 18px 5px; font-weight: 700; font-size: 1.2rem; font-family: 'Quicksand', sans-serif; }
        .opt-btn.correct { background: #22c55e; border-color: #4ade80; }
        .opt-btn.wrong { background: #ef4444; border-color: #f87171; }

        /* Mic Button Animation */
        .mic-btn {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .mic-btn.active { background: var(--yt-red); box-shadow: 0 0 30px var(--yt-red); animation: pulse-mic 1s infinite; }
        @keyframes pulse-mic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Game Elements */
        .game-target { 
            position: absolute; z-index: 200; font-size: 7.5rem; cursor: pointer;
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.7)); display: flex; align-items: center; justify-content: center; 
            width: 180px; height: 180px; touch-action: none; will-change: transform, left, top;
            transition: left 0.3s ease-out, top 0.3s ease-out;
        }
        .bubble { 
            border-radius: 50%; background: rgba(255,255,255,0.4); border: 4px solid rgba(255,255,255,0.5); 
            backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; 
            font-size: 3.5rem; position: absolute; animation: fly-up var(--d) linear forwards; 
        }
        @keyframes fly-up { from { transform: translateY(105vh); } to { transform: translateY(-20vh); } }

        /* Top Progress */
        .stories { position: fixed; top: var(--safe-top); left: 0; width: 100%; display: flex; gap: 4px; padding: 12px; z-index: 300; }
        .seg { flex: 1; height: 2.5px; background: rgba(255,255,255,0.25); border-radius: 2px; }
        .fill { height: 100%; width: 0%; background: #fff; }

        .confetti { position: absolute; pointer-events: none; z-index: 1000; animation: explode 1s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(360deg) scale(0); opacity: 0; } }
    </style>
</head>
<body>

    <div class="stories" id="stories"></div>
    <div id="shorts-feed" class="shorts-wrapper"></div>

    <!-- YouTube Navbar -->
    <nav class="fixed bottom-0 w-full h-[65px] bg-black border-t border-white/10 flex justify-around items-center z-[500] pb-[var(--safe-bottom)]">
        <div class="flex flex-col items-center"><i data-lucide="home" class="w-6 h-6 text-white"></i><span class="text-[10px] mt-1 font-bold text-white">Home</span></div>
        <div class="flex flex-col items-center"><i data-lucide="compass" class="w-6 h-6"></i><span class="text-[10px] mt-1 font-bold">Shorts</span></div>
        <div class="w-12 h-12 border border-white/40 rounded-full flex items-center justify-center"><i data-lucide="plus" class="w-8 h-8"></i></div>
        <div class="flex flex-col items-center opacity-40"><i data-lucide="play-square" class="w-6 h-6"></i><span class="text-[10px] mt-1 font-bold">Subs</span></div>
        <div class="flex flex-col items-center opacity-40"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px] mt-1 font-bold">You</span></div>
    </nav>

    <script>
        // Clean Data (Max 4 Letters)
        const ANIMALS = {"üê∂":"Dog","üê±":"Cat","üêª":"Bear","ü¶Å":"Lion","üêÆ":"Cow","üê∑":"Pig","üê∏":"Frog","üêî":"Hen","üê¶":"Bird","ü¶Ü":"Duck","ü¶á":"Bat","üê∫":"Wolf","ü¶å":"Deer","üêü":"Fish","üêê":"Goat","ü¶Ä":"Crab","üêù":"Bee","üêú":"Ant"};
        const FOOD = {"üçê":"Pear","Kiwi":"Kiwi","üåΩ":"Corn","ü•©":"Meat","üç∞":"Cake","ü•ß":"Pie","ü•ö":"Egg","ü•£":"Soup","üçö":"Rice","ü•õ":"Milk","üåÆ":"Taco","ü•Ø":"Bun"};
        const NUMS = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen","Twenty"];
        const GAMES = {"üçê":"Pear","‚öΩ":"Ball","‚≠ê":"Star","üßÅ":"Cake","ü•ö":"Egg","üåΩ":"Corn","üåÆ":"Taco","ü•£":"Soup"};

        let POOL = [];
        let state = {
            score: parseInt(localStorage.getItem('m_v11_stars') || 0),
            idx: -1,
            canAns: true,
            timers: [],
            voices: [],
            rec: null
        };

        function buildPool() {
            let temp = [];
            Object.keys(ANIMALS).forEach(e => temp.push({e, n: ANIMALS[e], c: "#6366f1", type: "spell"}));
            Object.keys(FOOD).forEach(e => temp.push({e, n: FOOD[e], c: "#ef4444", type: "spell"}));
            for(let i=1; i<=20; i++) temp.push({e:i, n: NUMS[i], c: "#10b981", type: "pick"});
            "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l => temp.push({e:l, n: l, c: "#f59e0b", type: "pick"}));
            
            temp.sort(() => Math.random() - 0.5);
            while(POOL.length < 400) POOL.push({...temp[POOL.length % temp.length]});
        }

        function init() {
            buildPool();
            const feed = document.getElementById('shorts-feed');
            const prog = document.getElementById('stories');

            POOL.forEach((item, i) => {
                const card = document.createElement('div');
                card.className = 'short-card';
                card.id = `card-${i}`;
                feed.appendChild(card);
                prog.innerHTML += `<div class="seg"><div id="fill-${i}" class="fill"></div></div>`;
            });

            lucide.createIcons();
            
            // Audio/Speech Init
            const setVoices = () => { state.voices = window.speechSynthesis.getVoices(); };
            setVoices();
            window.speechSynthesis.onvoiceschanged = setVoices;

            if ('webkitSpeechRecognition' in window) {
                state.rec = new webkitSpeechRecognition();
                state.rec.continuous = false;
                state.rec.interimResults = false;
                state.rec.lang = 'en-US';
            }

            feed.addEventListener('scroll', handleScroll, {passive: true});
            handleScroll();
        }

        function renderCard(i) {
            const card = document.getElementById(`card-${i}`);
            if (card.innerHTML !== '') return;

            const item = POOL[i];
            
            // Every 4th card is a game
            if (i > 0 && i % 4 === 3) {
                const games = ['catch', 'pop', 'tap'];
                const type = games[i % games.length];
                const emojis = Object.keys(GAMES);
                const emoji = emojis[i % emojis.length];
                card.dataset.type = "game";
                card.dataset.game = type;
                card.dataset.emoji = emoji;
                card.innerHTML = `
                    <div class="video-fx" style="--color: #ff0055"></div>
                    <div class="main-canvas">
                        <h2 class="text-4xl font-black italic mb-2 tracking-tighter">GAME TIME</h2>
                        <div id="zone-${i}" class="absolute inset-0 w-full h-full pointer-events-none"></div>
                    </div>
                    ${getSidebar()}
                    ${getBottom(`Mini Game`, `Catch the ${GAMES[emoji]}!`)}
                `;
            } 
            // Spell tasks
            else if (item.type === "spell" && i % 2 === 0) {
                card.dataset.type = "spell";
                card.innerHTML = `
                    <div class="video-fx" style="--color: ${item.c}"></div>
                    <div class="main-canvas">
                        <div class="emoji-hero">${item.e}</div>
                        <h3 class="text-2xl font-bold mb-4 uppercase">Can you say it?</h3>
                        <button id="mic-${i}" onclick="startMic(${i}, '${item.n}')" class="mic-btn">
                            <i data-lucide="mic" class="w-10 h-10"></i>
                        </button>
                    </div>
                    ${getSidebar()}
                    ${getBottom(`Speech Lab`, `Say the word ${item.n}!`)}
                `;
            }
            // Standard Pick tasks
            else {
                let opts = [item];
                while(opts.length < 4) {
                    let r = POOL[Math.floor(Math.random()*POOL.length)];
                    if(!opts.find(o => o.n === r.n)) opts.push(r);
                }
                opts.sort(() => Math.random() - 0.5);
                card.innerHTML = `
                    <div class="video-fx" style="--color: ${item.c}"></div>
                    <div class="main-canvas">
                        <div class="emoji-hero">${item.e}</div>
                        <div class="opt-grid">
                            ${opts.map(o => `<button onclick="checkPick(${i}, '${o.n}', '${item.n}', this)" class="opt-btn">${o.n}</button>`).join('')}
                        </div>
                    </div>
                    ${getSidebar()}
                    ${getBottom(`Marley Learn`, `Which one is ${item.n}?`)}
                `;
            }
            lucide.createIcons();
        }

        function getSidebar() {
            return `
                <div class="sidebar">
                    <div class="profile-ring"><img src="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG" class="profile-img"><div class="plus-sub">+</div></div>
                    <div class="sidebar-btn" onclick="pop(innerWidth/2, innerHeight/2)"><div class="icon-box"><i data-lucide="thumbs-up" class="w-7 h-7 fill-white"></i></div><span class="label">12K</span></div>
                    <div class="sidebar-btn"><div class="icon-box"><i data-lucide="message-square" class="w-7 h-7 fill-white"></i></div><span class="label">421</span></div>
                    <div class="sidebar-btn"><div class="icon-box"><i data-lucide="share-2" class="w-7 h-7 fill-white"></i></div><span class="label">Share</span></div>
                    <div class="w-8 h-8 rounded border-2 border-white overflow-hidden animate-[spin_4s_linear_infinite]"><img src="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG" class="w-full h-full object-cover"></div>
                </div>
            `;
        }

        function getBottom(title, desc) {
            return `
                <div class="bottom-ui">
                    <div class="handle-row">
                        <div class="w-8 h-8 rounded-full overflow-hidden border border-white/30"><img src="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG" class="w-full h-full object-cover"></div>
                        @marley_world <span class="sub-btn">Subscribe</span>
                    </div>
                    <div class="cap-text">${desc}</div>
                    <div class="music-tag flex items-center gap-2 text-sm bg-black/40 p-1 px-3 rounded"><i data-lucide="music" class="w-4 h-4"></i><marquee class="w-24">Original Audio - Marley</marquee></div>
                </div>
            `;
        }

        function handleScroll() {
            const feed = document.getElementById('shorts-feed');
            const idx = Math.round(feed.scrollTop / window.innerHeight);
            if(idx !== state.idx) {
                state.timers.forEach(t => clearInterval(t));
                state.timers = [];
                state.idx = idx;
                state.canAns = true;
                
                document.querySelectorAll('.short-card').forEach((c, i) => {
                    if (Math.abs(i - idx) > 1) c.innerHTML = '';
                    else renderCard(i);
                });

                document.querySelectorAll('.fill').forEach((f, i) => f.style.width = i <= idx ? '100%' : '0');

                const card = document.getElementById(`card-${idx}`);
                // START GAME OR SPEECH IMMEDIATELY
                if(card && card.dataset.type === "game") startPlay(idx, card.dataset.game, card.dataset.emoji);
                
                speak(idx);
            }
        }

        function startPlay(idx, type, emoji) {
            const zone = document.getElementById(`zone-${idx}`);
            if(!zone) return;
            zone.innerHTML = '';
            zone.style.pointerEvents = 'auto';

            if(type === 'catch') {
                const target = document.createElement('div');
                target.className = 'game-target';
                target.innerHTML = emoji;
                target.style.left = '50%';
                target.style.top = '50%';
                target.onpointerdown = (e) => { e.preventDefault(); win(idx, target); };
                zone.appendChild(target);
                const move = () => {
                    target.style.left = (Math.random() * (window.innerWidth - 180) + 10) + 'px';
                    target.style.top = (Math.random() * (window.innerHeight * 0.45) + (window.innerHeight * 0.2)) + 'px';
                    target.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;
                };
                state.timers.push(setInterval(move, 400));
                move();
            } 
            else if(type === 'pop') {
                const gen = () => {
                    if(zone.children.length > 8) return;
                    const b = document.createElement('div');
                    b.className = 'bubble';
                    b.innerHTML = emoji;
                    b.style.left = (Math.random() * 80 + 5) + '%';
                    b.style.width = b.style.height = (100 + Math.random() * 50) + 'px';
                    b.style.setProperty('--d', (2 + Math.random() * 1) + 's');
                    b.onpointerdown = (e) => { e.preventDefault(); b.style.transform='scale(0)'; setTimeout(()=>b.remove(),100); checkPop(idx); };
                    zone.appendChild(b);
                    setTimeout(() => b.remove(), 3500);
                };
                state.timers.push(setInterval(gen, 300));
            }
            else if(type === 'tap') {
                const target = document.createElement('div');
                target.className = 'game-target vibrate';
                target.innerHTML = emoji;
                target.style.left = '50%';
                target.style.top = '45%';
                target.style.transform = 'translate(-50%, -50%) scale(1.8)';
                let hits = 0;
                target.onpointerdown = (e) => { 
                    e.preventDefault();
                    hits++;
                    target.style.transform = `translate(-50%, -50%) scale(${1.8 + hits * 0.5})`;
                    pop(e.clientX || innerWidth/2, e.clientY || innerHeight/2);
                    if(hits >= 6) win(idx, target);
                };
                zone.appendChild(target);
            }
        }

        function checkPop(idx) {
            pop(innerWidth/2, innerHeight/2);
            if(Math.random() > 0.9) win(idx, null);
        }

        function win(idx, el) {
            if(el) { el.style.transform = "scale(20) rotate(720deg)"; el.style.opacity = "0"; el.style.pointerEvents = "none"; }
            state.timers.forEach(t => clearInterval(t));
            pop(innerWidth/2, innerHeight/2);
            narration("Wow! You won! Superstar!");
            setTimeout(() => document.getElementById('shorts-feed').scrollBy({top: window.innerHeight, behavior: 'smooth'}), 1200);
        }

        function checkPick(i, pick, match, btn) {
            if(!state.canAns) return;
            window.speechSynthesis.cancel();
            if(pick === match) {
                state.canAns = false;
                btn.classList.add('correct');
                pop(innerWidth/2, innerHeight/2);
                narration(`Yes! ${match} is right!`);
                setTimeout(() => document.getElementById('shorts-feed').scrollBy({top: window.innerHeight, behavior: 'smooth'}), 1500);
            } else {
                btn.classList.add('wrong');
                narration("Try again!");
                setTimeout(() => btn.classList.remove('wrong'), 600);
            }
        }

        function startMic(idx, target) {
            if (!state.rec) return;
            const btn = document.getElementById(`mic-${idx}`);
            btn.classList.add('active');
            
            state.rec.start();
            state.rec.onresult = (e) => {
                const heard = e.results[0][0].transcript.toLowerCase();
                btn.classList.remove('active');
                if (heard.includes(target.toLowerCase())) {
                    pop(innerWidth/2, innerHeight/2);
                    narration("Incredible! You said it!");
                    setTimeout(() => document.getElementById('shorts-feed').scrollBy({top: window.innerHeight, behavior: 'smooth'}), 1200);
                } else {
                    narration(`I heard ${heard}. Try again!`);
                }
            };
            state.rec.onerror = () => btn.classList.remove('active');
        }

        function speak(i) {
            window.speechSynthesis.cancel();
            const card = document.getElementById(`card-${i}`);
            if (!card) return;
            let text = "";
            if(card.dataset.type === "game") {
                const g = card.dataset.game;
                const n = GAMES[card.dataset.emoji];
                if(g === 'catch') text = `Catch the ${n}!`;
                else if(g === 'pop') text = `Pop the bubbles!`;
                else text = `Tap the ${n}!`;
            } else if (card.dataset.type === "spell") {
                text = `Say the word ${POOL[i].n}`;
            } else {
                text = `${POOL[i].n}. Find ${POOL[i].n}?`;
            }
            narration(text);
        }

        function narration(text) {
            const u = new SpeechSynthesisUtterance(text);
            const high = state.voices.find(v => (v.name.includes("Neural") || v.name.includes("Enhanced") || v.name.includes("Premium") || v.name.includes("Samantha")) && v.lang.startsWith("en"));
            if(high) u.voice = high;
            u.pitch = 1.1;
            u.rate = 1.0;
            window.speechSynthesis.speak(u);
        }

        function pop(x, y) {
            const emojis = ['‚≠ê','‚ú®','üéà','üéä','‚ù§Ô∏è','üî•'];
            for(let i=0; i<12; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerHTML = emojis[Math.floor(Math.random()*emojis.length)];
                c.style.left = x + 'px';
                c.style.top = y + 'px';
                c.style.setProperty('--tx', (Math.random()-0.5) * 600 + 'px');
                c.style.setProperty('--ty', (Math.random()-0.5) * 600 + 'px');
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 1200);
            }
        }

        window.onload = init;
    </script>
</body>
</html>

