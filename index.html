<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Marley Shorts Pre-K</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG">
    <link rel="icon" href="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --yt-red: #ff0000;
            --neon-orange: #FFAC1C;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000;
            color: white;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .shorts-wrapper {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .shorts-wrapper::-webkit-scrollbar { display: none; }

        .short-card {
            height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        .prog-header {
            position: fixed;
            top: calc(var(--safe-top) + 4px);
            left: 0;
            width: 100%;
            display: flex;
            gap: 2px;
            padding: 0 8px;
            z-index: 1001;
            pointer-events: none;
        }
        .seg { flex: 1; height: 2.5px; background: rgba(255,255,255,0.2); border-radius: 1px; }
        .fill { height: 100%; width: 0%; background: #fff; transition: width 0.3s; }

        .yt-header {
            position: fixed;
            top: calc(var(--safe-top) + 12px);
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            z-index: 1000;
            pointer-events: none;
        }
        .shorts-logo-text { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; pointer-events: auto; }
        .header-right { display: flex; align-items: center; gap: 20px; pointer-events: auto; }

        .sidebar {
            position: absolute;
            right: 8px;
            bottom: calc(75px + var(--safe-bottom));
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 100;
        }
        .sidebar-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .sidebar-icon { width: 30px; height: 30px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }
        .sidebar-label { font-size: 12px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        .profile-box { position: relative; width: 42px; height: 42px; margin-bottom: 8px; }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; border: 1.5px solid #fff; object-fit: cover; }
        .plus-icon {
            position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            background: var(--yt-red); width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; border: 2px solid #000;
        }
        .audio-disc { width: 32px; height: 32px; border-radius: 4px; border: 2px solid #333; overflow: hidden; animation: spin-disc 4s linear infinite; }
        @keyframes spin-disc { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .bottom-ui {
            position: absolute; bottom: calc(15px + var(--safe-bottom));
            left: 14px; right: 75px; z-index: 100; pointer-events: none;
        }
        .handle-row { font-weight: 700; font-size: 15px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; pointer-events: auto; }
        .sub-btn { background: #fff; color: #000; padding: 6px 14px; border-radius: 100px; font-size: 12px; font-weight: 700; }
        .caption { font-size: 16px; font-weight: 400; line-height: 1.4; margin-bottom: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); pointer-events: auto; }
        .audio-row { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; opacity: 0.9; pointer-events: auto; }

        .video-fx { position: absolute; inset: 0; background: radial-gradient(circle at 50% 50%, var(--color, #6366f1) 0%, #000 100%); opacity: 0.7; z-index: 0; }
        .main-canvas { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; width: 100%; pointer-events: none; }
        
        .edu-animation {
            font-size: 10rem; 
            font-weight: 900; 
            filter: drop-shadow(0 0 40px rgba(255, 172, 28, 0.5));
            font-family: 'Outfit', sans-serif;
            margin-bottom: 20px; 
            pointer-events: auto;
            animation: float-edu 3s ease-in-out infinite;
        }
        @keyframes float-edu {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(5deg); }
        }
        
        .grid-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 340px; padding: 0 20px; pointer-events: auto; }
        .opt-bubble { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 16px; 
            padding: 22px 5px; 
            font-weight: 800; font-size: 1.8rem; color: white; cursor: pointer; text-transform: uppercase; 
            transition: background 0.2s, transform 0.1s;
        }
        .opt-bubble.correct { background: #22c55e !important; border-color: #fff; transform: scale(1.05); }

        .mic-btn { 
            width: 140px; height: 140px; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            border: 6px solid rgba(255, 255, 255, 0.3); 
            margin-top: 20px; 
            cursor: pointer; pointer-events: auto; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.active { background: #ef4444; border-color: #fff; box-shadow: 0 0 80px #ef4444; animation: pulse-mic 1s infinite; }

        .mic-vol-ring {
            position: absolute;
            inset: -15px;
            border: 5px solid #ef4444;
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.8);
            transition: transform 0.05s linear;
            pointer-events: none;
        }
        .mic-btn.active .mic-vol-ring { opacity: 0.6; }

        .yt-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            height: 50px; background: #000; 
            border-top: 0.5px solid rgba(255,255,255,0.1); 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 2000; padding-bottom: var(--safe-bottom); 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; opacity: 0.8; }
        .nav-label { font-size: 10px; font-weight: 500; margin-top: 2px; }

        @keyframes pulse-mic { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        
        .confetti { position: absolute; pointer-events: none; z-index: 1000; animation: pop-confetti 1.2s ease-out forwards; font-size: 3rem; }
        @keyframes pop-confetti { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(360deg) scale(0); opacity: 0; } }

        .score-display { position: fixed; top: calc(var(--safe-top) + 12px); right: 110px; z-index: 1001; font-weight: 900; color: #ffd700; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .status-pill {
            position: absolute; bottom: 170px; left: 50%; transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9); color: white; padding: 4px 12px; border-radius: 100px;
            font-size: 12px; font-weight: 700; opacity: 0; transition: opacity 0.3s; pointer-events: none;
            display: flex; align-items: center; gap: 6px;
        }
        .active-visual .status-pill { opacity: 1; }
    </style>
</head>
<body>

    <div class="prog-header" id="prog-header"></div>
    
    <div class="yt-header">
        <div class="header-left"><span class="shorts-logo-text">Shorts</span></div>
        <div class="header-right">
            <i data-lucide="search" class="w-6 h-6"></i>
            <i data-lucide="camera" class="w-6 h-6"></i>
            <i data-lucide="more-vertical" class="w-6 h-6"></i>
        </div>
    </div>

    <div class="score-display"><span id="score-val">0</span> ‚≠ê</div>

    <div id="shorts-feed" class="shorts-wrapper"></div>

    <nav class="yt-nav">
        <div class="nav-item"><i data-lucide="home" class="w-6 h-6"></i><span class="nav-label">Home</span></div>
        <div class="nav-item"><i data-lucide="compass" class="w-6 h-6"></i><span class="nav-label">Shorts</span></div>
        <div class="w-10 h-10 border border-white rounded-lg flex items-center justify-center"><i data-lucide="plus" class="w-7 h-7"></i></div>
        <div class="nav-item opacity-40"><i data-lucide="play-square" class="w-6 h-6"></i><span class="nav-label">Subs</span></div>
        <div class="nav-item opacity-40"><i data-lucide="user" class="w-6 h-6"></i><span class="nav-label">You</span></div>
    </nav>

    <script>
        const APP_ICON = "https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG";
        const EASY_WORDS = ["GO", "HI", "YOU", "ME", "BYE", "UP", "IN", "ON", "AT", "IT", "TO", "WE", "HE", "BE", "NO", "DO", "AM", "MY", "SUN", "RUN", "FUN", "BUS", "CAR", "BOY", "TOY", "RED", "SIX", "TEN", "ONE", "TWO", "HAT", "BED", "CUP", "MOM", "DAD", "PAW", "SEA", "SKY", "ICE", "TEA", "EAT", "INK", "BAG", "MUG", "KEY", "CAN", "PAN", "FAN", "VAN", "YES", "EYE", "ARM", "LEG", "NET", "PET", "WET", "LET", "GET", "DOT", "HOT", "NOT", "TOP", "HOP", "MOP", "POP", "NAP", "LAP", "TAP", "CAP", "MAP", "JAR", "TAX"];
        const ANIMALS = [{v: "CAT", e: "üê±"}, {v: "DOG", e: "üê∂"}, {v: "PIG", e: "üê∑"}, {v: "COW", e: "üêÆ"}, {v: "ANT", e: "üêú"}, {v: "BEE", e: "üêù"}, {v: "HEN", e: "üêî"}, {v: "FOX", e: "ü¶ä"}, {v: "OWL", e: "ü¶â"}, {v: "BUG", e: "üêõ"}, {v: "BAT", e: "ü¶á"}, {v: "RAT", e: "üê≠"}];
        const FRUITS = [{v: "PEA", e: "ü´õ"}, {v: "NUT", e: "ü•ú"}, {v: "FIG", e: "üçê"}, {v: "BUN", e: "ü•Ø"}, {v: "EGG", e: "ü•ö"}, {v: "JAM", e: "ü´ô"}];
        const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        const NUMBERS = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
        const EMOJIS = ["üéà", "üåü", "ü¶Å", "üê∂", "üçì", "üöó", "üçé", "üê±", "üç¶", "‚öΩ", "üåà", "üçï"];
        
        let state = {
            idx: 0,
            timers: [],
            voices: [],
            rec: null,
            isMicListening: false,
            audioRequestId: 0,
            pool: [],
            score: parseInt(localStorage.getItem('marley_prek_score') || 0),
            audioCtx: null,
            analyser: null,
            micStream: null,
            lastResult: ""
        };

        function buildPool() {
            let questions = [];
            EASY_WORDS.forEach(w => questions.push({v: w, type: "spell", color: `hsl(${Math.random() * 360}, 65%, 40%)`}));
            ANIMALS.forEach(a => questions.push({v: a.v, icon: a.e, type: "visual", color: "#6366f1"}));
            FRUITS.forEach(f => questions.push({v: f.v, icon: f.e, type: "visual", color: "#22c55e"}));
            LETTERS.forEach(l => questions.push({v: l, type: "pick", color: "#f59e0b"}));
            NUMBERS.forEach(n => questions.push({v: n, type: "pick", color: "#10b981"}));
            questions.sort(() => Math.random() - 0.5);
            let final = [];
            let qIdx = 0;
            const gameTypes = ["pop", "catch", "tap"];
            for(let i=0; i < 300; i++) {
                if(i > 0 && i % 4 === 3) final.push({type: "game", gameType: gameTypes[Math.floor(i/4) % gameTypes.length], emoji: EMOJIS[Math.floor(i/4) % EMOJIS.length], color: "#ff0055"});
                else if (i > 0 && i % 3 === 2) final.push({v: EASY_WORDS[Math.floor(Math.random()*EASY_WORDS.length)], type: "spell", color: "#FFAC1C"});
                else if(questions[qIdx]) final.push(questions[qIdx++]);
            }
            state.pool = final;
        }

        function speak(text, requestId) {
            window.speechSynthesis.cancel();
            if (requestId !== state.audioRequestId) return;
            const u = new SpeechSynthesisUtterance(text.toLowerCase());
            const v = state.voices.find(v => v.lang.startsWith("en") && (v.name.includes("Google") || v.name.includes("Natural")));
            if(v) u.voice = v;
            u.pitch = 1.3; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        async function initAudioVisuals() {
            if (state.audioCtx) return;
            try {
                state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioCtx.createAnalyser();
                state.micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audioCtx.createMediaStreamSource(state.micStream).connect(state.analyser);
                const update = () => {
                    if (state.isMicListening && state.analyser) {
                        const data = new Uint8Array(state.analyser.frequencyBinCount);
                        state.analyser.getByteFrequencyData(data);
                        let avg = data.reduce((a,b) => a+b) / data.length;
                        const ring = document.querySelector('.mic-btn.active .mic-vol-ring');
                        if (ring) ring.style.transform = `scale(${1 + (avg / 100)})`;
                    }
                    requestAnimationFrame(update);
                };
                update();
            } catch(e) { console.error("Mic access denied", e); }
        }

        function init() {
            document.getElementById('score-val').innerText = state.score;
            buildPool();
            const feed = document.getElementById('shorts-feed');
            const prog = document.getElementById('prog-header');
            state.pool.forEach((item, i) => {
                const card = document.createElement('div');
                card.className = 'short-card'; card.id = `card-${i}`;
                feed.appendChild(card);
                prog.innerHTML += `<div class="seg"><div id="fill-${i}" class="fill"></div></div>`;
            });

            const loadV = () => { state.voices = window.speechSynthesis.getVoices(); };
            loadV();
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadV;
            
            if ('webkitSpeechRecognition' in window) {
                state.rec = new webkitSpeechRecognition();
                state.rec.continuous = true;
                state.rec.interimResults = true;
                state.rec.lang = 'en-US';
            }

            feed.addEventListener('scroll', handleScroll, {passive: true});
            renderCard(0);
            setTimeout(() => speak(getQuestionText(state.pool[0]), state.audioRequestId), 600);
            lucide.createIcons();
        }

        function getQuestionText(item) {
            if (item.type === "game") return item.gameType === "pop" ? "Pop all!" : (item.gameType === "catch" ? "Catch it!" : "Tap tap!");
            if (item.type === "spell") return `Can you say ${item.v}?`;
            return `Find ${item.v}`;
        }

        function renderCard(i) {
            const card = document.getElementById(`card-${i}`);
            if (!card || card.innerHTML !== '') return;
            const item = state.pool[i];
            let content = "";
            let capStr = "";

            if (item.type === "game") {
                content = `<div class="game-overlay" id="game-overlay-${i}"></div><div class="main-canvas" style="opacity:0.2"><div class="edu-animation">GAME</div></div>`;
                capStr = item.gameType === "pop" ? "Pop all the bubbles!" : (item.gameType === "catch" ? "Catch it!" : "Tap the emoji!");
            } else if (item.type === "spell") {
                content = `
                    <div class="main-canvas">
                        <div class="edu-animation">${item.v}</div>
                        <div id="mic-container-${i}">
                            <button id="mic-${i}" onclick="startMic(${i}, '${item.v}')" class="mic-btn">
                                <div class="mic-vol-ring"></div>
                                <i data-lucide="mic" class="w-20 h-20 text-white"></i>
                            </button>
                            <div class="status-pill">
                                <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div> LISTENING...
                            </div>
                        </div>
                    </div>`;
                capStr = `Can you say ${item.v}?`;
            } else {
                let opts = [item.v];
                while(opts.length < 4) {
                    let r = EASY_WORDS[Math.floor(Math.random()*EASY_WORDS.length)];
                    if(!opts.includes(r)) opts.push(r);
                }
                opts.sort(() => Math.random() - 0.5);
                const visual = item.type === "visual" ? `<div class="text-9xl">${item.icon}</div>` : item.v;
                content = `<div class="main-canvas"><div class="edu-animation">${visual}</div><div class="grid-opts">${opts.map(o => `<button onclick="checkPick(${i}, '${o}', '${item.v}', this)" class="opt-bubble">${o}</button>`).join('')}</div></div>`;
                capStr = `Find the word ${item.v}`;
            }

            card.innerHTML = `
                <div class="video-fx" style="--color: ${item.color}"></div>
                ${content}
                <div class="sidebar">
                    <div class="profile-box"><img src="${APP_ICON}" class="profile-img"><div class="plus-icon">+</div></div>
                    <div class="sidebar-btn" onclick="celebrate(innerWidth/2, innerHeight/2)"><i data-lucide="thumbs-up" class="sidebar-icon"></i><span class="sidebar-label">12K</span></div>
                    <div class="sidebar-btn"><i data-lucide="message-square" class="sidebar-icon"></i><span class="sidebar-label">428</span></div>
                    <div class="sidebar-btn"><i data-lucide="share-2" class="sidebar-icon"></i><span class="sidebar-label">Share</span></div>
                    <div class="audio-disc"><img src="${APP_ICON}" class="w-full h-full object-cover"></div>
                </div>
                <div class="bottom-ui">
                    <div class="handle-row">@marley_world <span class="sub-btn">Subscribe</span></div>
                    <div class="caption">${capStr}</div>
                    <div class="audio-row"><i data-lucide="music" class="w-4 h-4"></i> Original sound - Marley</div>
                </div>
            `;
            lucide.createIcons();
        }

        function handleScroll() {
            const feed = document.getElementById('shorts-feed');
            const idx = Math.round(feed.scrollTop / window.innerHeight);
            if(idx !== state.idx) {
                stopMicInternal();
                state.timers.forEach(clearInterval);
                state.timers = [];
                state.audioRequestId++;
                state.idx = idx; 
                document.querySelectorAll('.short-card').forEach((c, i) => {
                    if (Math.abs(i - idx) > 1) c.innerHTML = '';
                    else renderCard(i);
                });
                document.querySelectorAll('.fill').forEach((f, i) => f.style.width = i <= idx ? '100%' : '0');
                const item = state.pool[idx];
                setTimeout(() => speak(getQuestionText(item), state.audioRequestId), 500);
                if (item.type === "game") setTimeout(() => runGame(idx), 600);
            }
        }

        async function startMic(idx, targetText) {
            if (!state.rec || state.idx !== idx) return;
            if (state.isMicListening) { stopMicInternal(); return; }
            
            await initAudioVisuals();
            state.isMicListening = true;
            
            const btn = document.getElementById(`mic-${idx}`);
            const container = document.getElementById(`mic-container-${idx}`);
            btn.classList.add('active');
            container.classList.add('active-visual');

            const target = targetText.toLowerCase().trim();
            
            state.rec.onresult = (e) => {
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    const heard = e.results[i][0].transcript.toLowerCase();
                    // INTERIM MATCHING: Check immediately if the word is anywhere in the transcript
                    if (heard.includes(target)) {
                        state.rec.onresult = null; // Prevent double trigger
                        stopMicInternal();
                        updateScore();
                        celebrate(innerWidth/2, innerHeight/2);
                        speak("Perfect!", state.audioRequestId);
                        return;
                    }
                }
            };

            state.rec.onerror = () => stopMicInternal();
            state.rec.onend = () => { if (state.isMicListening) state.rec.start(); };
            
            try { state.rec.start(); } catch(err) {}
        }

        function stopMicInternal() {
            state.isMicListening = false;
            if(state.rec) try { state.rec.stop(); } catch(e) {}
            document.querySelectorAll('.mic-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('[id^="mic-container-"]').forEach(c => c.classList.remove('active-visual'));
        }

        function checkPick(i, p, m, b) {
            if(p === m) {
                b.classList.add('correct');
                updateScore(); celebrate(innerWidth/2, innerHeight/2);
                speak("Great job!", state.audioRequestId);
            } else {
                speak("Try again", state.audioRequestId);
            }
        }

        function updateScore() {
            state.score += 10;
            document.getElementById('score-val').innerText = state.score;
            localStorage.setItem('marley_prek_score', state.score);
        }

        function celebrate(x, y) {
            const items = ['üåü','üéà','üåà','üçé','üç≠','‚ú®','‚ù§Ô∏è'];
            for(let i=0; i<15; i++) {
                const c = document.createElement('div'); c.className = 'confetti';
                c.innerHTML = items[Math.floor(Math.random()*items.length)];
                c.style.left = x + 'px'; c.style.top = y + 'px';
                c.style.setProperty('--tx', (Math.random()-0.5) * 400 + 'px');
                c.style.setProperty('--ty', (Math.random()-0.5) * 400 + 'px');
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 1200);
            }
        }

        function runGame(idx) {
            const item = state.pool[idx];
            const zone = document.getElementById(`game-overlay-${idx}`);
            if(!zone) return;
            if(item.gameType === "pop") {
                const sp = () => {
                    const b = document.createElement('div'); b.style.position = 'absolute';
                    b.innerHTML = `<span style="font-size: 4rem">${item.emoji}</span>`;
                    b.style.left = (Math.random() * 80 + 10) + '%';
                    b.style.bottom = '-100px';
                    b.style.transition = 'transform 3s linear';
                    zone.appendChild(b);
                    setTimeout(() => b.style.transform = 'translateY(-120vh)', 50);
                    b.onpointerdown = (e) => { celebrate(e.clientX, e.clientY); b.remove(); updateScore(); };
                    setTimeout(() => b.remove(), 4000);
                };
                state.timers.push(setInterval(sp, 800));
            }
        }

        window.onload = init;
    </script>
</body>
</html>

