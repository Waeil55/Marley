<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Marley's World - Pre-K Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #FF9800;
            --font-main: 'Bubblegum Sans', cursive;
        }
        body {
            font-family: var(--font-main);
            background-color: #FFFDE7;
            color: #4E342E;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .bubble-btn {
            border-radius: 35px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            transition: all 0.1s;
        }
        .bubble-btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .rainbow-text {
            background-image: linear-gradient(to left, #ec4899, #8b5cf6, #3b82f6, #10b981, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            color: transparent;
        }
        .mic-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .hidden-view { display: none; }
        .confetti {
            position: fixed;
            width: 8px; height: 8px;
            z-index: 100;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="confetti-layer"></div>

    <header class="p-4 bg-white rounded-b-[40px] shadow-sm sticky top-0 z-40">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                <div class="w-12 h-12 bg-orange-100 rounded-xl p-1 border-2 border-orange-400">
                    <img src="https://github.com/Waeil55/Marley/blob/main/M.PNG" class="w-full h-full object-contain" alt="M">
                </div>
                <h1 class="text-2xl font-black text-orange-500">MARLEY</h1>
            </div>
            <div class="flex items-center gap-2">
                <div class="bg-yellow-100 px-4 py-1 rounded-full border-2 border-yellow-400 flex items-center gap-2">
                    <span class="text-xl">‚≠ê</span>
                    <span id="global-score" class="text-xl font-black text-yellow-700">0</span>
                </div>
                <button onclick="goHome()" id="home-btn" class="hidden-view w-10 h-10 bg-sky-100 text-sky-600 rounded-xl flex items-center justify-center border-2 border-sky-400">
                    <i data-lucide="home"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
        <!-- Main Hub -->
        <div id="home-view" class="space-y-6">
            <div class="text-center py-2">
                <h2 class="text-3xl font-black rainbow-text italic">Time to Play!</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div onclick="startActivity('speech')" class="bubble-btn bg-red-400 p-6 text-white text-center cursor-pointer border-4 border-red-200 col-span-2">
                    <div class="text-5xl mb-1">üé§</div>
                    <span class="text-2xl font-black uppercase tracking-widest">Speech Lab</span>
                </div>
                <div onclick="startActivity('listening')" class="bubble-btn bg-indigo-400 p-6 text-white text-center cursor-pointer border-4 border-indigo-200 col-span-2">
                    <div class="text-5xl mb-1">üëÇ</div>
                    <span class="text-2xl font-black uppercase tracking-widest">Listen & Pick</span>
                </div>
                <div onclick="startActivity('abc')" class="bubble-btn bg-pink-400 p-5 text-white text-center cursor-pointer border-4 border-pink-200">
                    <div class="text-4xl mb-1">ABC</div>
                    <span class="text-lg font-black uppercase">Letters</span>
                </div>
                <div onclick="startActivity('numbers')" class="bubble-btn bg-blue-400 p-5 text-white text-center cursor-pointer border-4 border-blue-200">
                    <div class="text-4xl mb-1">123</div>
                    <span class="text-lg font-black uppercase">Numbers</span>
                </div>
                <div onclick="startActivity('animals')" class="bubble-btn bg-orange-400 p-5 text-white text-center cursor-pointer border-4 border-orange-200">
                    <div class="text-4xl mb-1">üê∂</div>
                    <span class="text-lg font-black uppercase">Animals</span>
                </div>
                <div onclick="startActivity('fruits')" class="bubble-btn bg-green-400 p-5 text-white text-center cursor-pointer border-4 border-green-200">
                    <div class="text-4xl mb-1">üçé</div>
                    <span class="text-lg font-black uppercase">Fruits</span>
                </div>
            </div>
        </div>

        <!-- Activity View -->
        <div id="activity-view" class="hidden-view space-y-4">
            <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden mb-2">
                <div id="progress-bar" class="bg-orange-400 h-full transition-all" style="width: 0%"></div>
            </div>
            <div class="text-center font-black text-gray-400 text-sm mb-4">
                Question <span id="current-count">1</span> of 150
            </div>

            <div id="game-card" class="bg-white rounded-[50px] p-8 shadow-xl border-b-8 border-gray-100 text-center relative min-h-[400px] flex flex-col justify-center">
                <div id="task-title" class="text-2xl font-black text-orange-500 mb-4 uppercase"></div>
                
                <div id="visual-content" class="text-9xl mb-8 flex justify-center items-center"></div>

                <div id="interaction-area">
                    <div id="options-grid" class="grid grid-cols-2 gap-4"></div>
                    
                    <div id="mic-area" class="hidden flex flex-col items-center gap-4">
                        <button id="mic-btn" onclick="toggleMic()" class="w-24 h-24 rounded-full bg-red-100 border-4 border-red-200 text-red-500 flex items-center justify-center shadow-lg active:scale-90 transition-all">
                            <i data-lucide="mic" class="w-12 h-12"></i>
                        </button>
                        <p id="mic-status" class="text-xl font-black text-red-400">Tap & Say it!</p>
                        <p id="heard-text" class="text-lg text-gray-300 italic font-bold h-6"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Win View -->
        <div id="win-view" class="hidden-view py-16 text-center">
            <div class="text-9xl mb-6">üëë</div>
            <h2 class="text-5xl font-black text-orange-500 mb-4">MARLEY PRIDE!</h2>
            <p class="text-2xl font-black text-gray-500 mb-10">You finished 150 lessons!</p>
            <button onclick="goHome()" class="bubble-btn bg-orange-500 text-white px-10 py-5 text-2xl font-black border-b-8 border-orange-700">PLAY AGAIN</button>
        </div>
    </main>

    <script>
        // Core Assets (Pre-K Friendly)
        const ABC_POOL = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");
        const NUM_POOL = ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"];
        const ANIMAL_POOL = [
            {e:"üê∂",n:"Dog"},{e:"üê±",n:"Cat"},{e:"üê≠",n:"Mouse"},{e:"üê∞",n:"Bunny"},{e:"ü¶ä",n:"Fox"},
            {e:"üêª",n:"Bear"},{e:"üêº",n:"Panda"},{e:"ü¶Å",n:"Lion"},{e:"üêÆ",n:"Cow"},{e:"üê∑",n:"Pig"},
            {e:"üê∏",n:"Frog"},{e:"üêµ",n:"Monkey"},{e:"üêî",n:"Hen"},{e:"üêß",n:"Penguin"},{e:"üê¢",n:"Turtle"}
        ];
        const FRUIT_POOL = [
            {e:"üçé",n:"Apple"},{e:"üçå",n:"Banana"},{e:"üçä",n:"Orange"},{e:"üçê",n:"Pear"},{e:"üçì",n:"Berry"},
            {e:"üçá",n:"Grape"},{e:"üçâ",n:"Melon"},{e:"üçí",n:"Cherry"},{e:"üçç",n:"Pine"},{e:"üçã",n:"Lemon"}
        ];

        const STATE = {
            score: parseInt(localStorage.getItem('marley_pk_stars') || 0),
            mode: '',
            questions: [],
            currentIndex: 0,
            isListening: false,
            recognition: null
        };

        // --- Voice ---
        function speak(text) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 0.9;
            msg.pitch = 1.3;
            window.speechSynthesis.speak(msg);
        }

        // --- Advanced Mic ---
        function initMic() {
            if (!('webkitSpeechRecognition' in window)) return;
            STATE.recognition = new webkitSpeechRecognition();
            STATE.recognition.lang = 'en-US';
            STATE.recognition.onstart = () => {
                STATE.isListening = true;
                document.getElementById('mic-btn').classList.add('mic-pulse', 'bg-red-200');
                document.getElementById('mic-status').innerText = "Marley is listening...";
            };
            STATE.recognition.onend = () => {
                STATE.isListening = false;
                document.getElementById('mic-btn').classList.remove('mic-pulse', 'bg-red-200');
                document.getElementById('mic-status').innerText = "Tap & Say it!";
            };
            STATE.recognition.onresult = (e) => {
                const heard = e.results[0][0].transcript.toLowerCase();
                document.getElementById('heard-text').innerText = `You said: ${heard}`;
                checkSpeech(heard);
            };
        }

        function toggleMic() {
            if (!STATE.recognition) return;
            STATE.isListening ? STATE.recognition.stop() : STATE.recognition.start();
        }

        // --- Data Gen (150 Items) ---
        function build150(source, type) {
            let result = [];
            while(result.length < 150) {
                let shuffled = [...source].sort(() => 0.5 - Math.random());
                shuffled.forEach(item => {
                    if(result.length >= 150) return;
                    let correct = (typeof item === 'string') ? item : item.n;
                    let display = (typeof item === 'string') ? item : item.e;
                    
                    // Generate options
                    let pool = (typeof item === 'string') ? source : source.map(x => x.n);
                    let others = pool.filter(x => x !== correct).sort(() => 0.5 - Math.random()).slice(0, 3);
                    let opts = [correct, ...others].sort(() => 0.5 - Math.random());
                    
                    result.push({ d: display, n: correct, opts: opts });
                });
            }
            return result;
        }

        // --- Game Flow ---
        function goHome() {
            document.getElementById('activity-view').classList.add('hidden-view');
            document.getElementById('win-view').classList.add('hidden-view');
            document.getElementById('home-btn').classList.add('hidden-view');
            document.getElementById('home-view').classList.remove('hidden-view');
            speak("Welcome back!");
        }

        function startActivity(type) {
            STATE.mode = type;
            STATE.currentIndex = 0;
            
            if(type === 'abc') STATE.questions = build150(ABC_POOL);
            else if(type === 'numbers') STATE.questions = build150(NUM_POOL);
            else if(type === 'animals') STATE.questions = build150(ANIMAL_POOL);
            else if(type === 'fruits') STATE.questions = build150(FRUIT_POOL);
            else if(type === 'listening') {
                const mega = [...ABC_POOL.slice(0,10), ...NUM_POOL, ...ANIMAL_POOL.map(x=>x.n)];
                STATE.questions = build150(mega);
            }
            else if(type === 'speech') {
                const mega = [...ANIMAL_POOL, ...FRUIT_POOL];
                STATE.questions = build150(mega);
            }

            document.getElementById('home-view').classList.add('hidden-view');
            document.getElementById('activity-view').classList.remove('hidden-view');
            document.getElementById('home-btn').classList.remove('hidden-view');
            renderQ();
        }

        function renderQ() {
            const q = STATE.questions[STATE.currentIndex];
            const title = document.getElementById('task-title');
            const visual = document.getElementById('visual-content');
            const grid = document.getElementById('options-grid');
            const mic = document.getElementById('mic-area');
            
            document.getElementById('progress-bar').style.width = `${(STATE.currentIndex/150)*100}%`;
            document.getElementById('current-count').innerText = STATE.currentIndex + 1;
            document.getElementById('heard-text').innerText = '';
            
            grid.innerHTML = '';
            mic.classList.add('hidden');

            if(STATE.mode === 'listening') {
                title.innerText = "Listen & Find!";
                visual.innerHTML = `<button onclick="speak('${q.n}')" class="w-32 h-32 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-500"><i data-lucide="volume-2" class="w-16 h-16"></i></button>`;
                speak(`Can you find ${q.n}?`);
            } else if(STATE.mode === 'speech') {
                title.innerText = "Can you say it?";
                visual.innerText = q.d;
                mic.classList.remove('hidden');
                speak(`Can you say ${q.n}?`);
            } else {
                title.innerText = "Find the match!";
                visual.innerText = q.d;
                speak(`Find the ${q.n}`);
            }

            if(q.opts && STATE.mode !== 'speech') {
                q.opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "bubble-btn bg-white border-4 border-gray-100 p-6 text-3xl font-black text-orange-600";
                    btn.innerText = opt;
                    btn.onclick = () => checkAns(opt);
                    grid.appendChild(btn);
                });
            }
            lucide.createIcons();
        }

        function checkAns(val) {
            if(val === STATE.questions[STATE.currentIndex].n) winQ();
            else speak("Try again!");
        }

        function checkSpeech(heard) {
            const target = STATE.questions[STATE.currentIndex].n.toLowerCase();
            if(heard.includes(target)) winQ();
            else speak(`I heard ${heard}. Try again!`);
        }

        function winQ() {
            STATE.score += 5;
            localStorage.setItem('marley_pk_stars', STATE.score);
            document.getElementById('global-score').innerText = STATE.score;
            
            popConfetti();
            const praises = ["Yay!", "Super!", "Good job!", "Marley is happy!", "Wow!"];
            speak(praises[Math.floor(Math.random()*praises.length)]);

            setTimeout(() => {
                if(STATE.currentIndex < 149) {
                    STATE.currentIndex++;
                    renderQ();
                } else {
                    document.getElementById('activity-view').classList.add('hidden-view');
                    document.getElementById('win-view').classList.remove('hidden-view');
                    speak("You are a superstar!");
                }
            }, 800);
        }

        function popConfetti() {
            const colors = ['#f00','#0f0','#00f','#ff0','#f0f'];
            for(let i=0; i<15; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.top = '-10px';
                c.style.backgroundColor = colors[Math.floor(Math.random()*5)];
                document.getElementById('confetti-layer').appendChild(c);
                c.animate([{transform:'translateY(0)',opacity:1},{transform:'translateY(100vh)',opacity:0}],{duration:1000}).onfinish=()=>c.remove();
            }
        }

        window.onload = () => {
            document.getElementById('global-score').innerText = STATE.score;
            initMic();
            lucide.createIcons();
        };
    </script>
</body>
</html>



